@page
@model Connect4_Server.Pages.QueriesModel
@{
    ViewData["Title"] = "Player Queries";
}

@* Queries dashboard:
   - Implements the assignment queries (17–24) over Players/Games.
   - Sections:
     1) Player picker + details + edit/delete actions
     2) Selected player's games with "Replay" action
     3) Players list (sortable)
     4) Games per player (counts)
     5) Last game date per player (case-sensitive DESC name)
     6) All games
     7) Distinct games by player (one per player)
     8) Grouping by number of games
     9) Grouping by country *@

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@if (TempData["Info"] != null)
{
    <div class="alert alert-info">@TempData["Info"]</div>
}

<h2>All Registered Players</h2>

@* Player picker (by external PlayerId) *@
<h4>Select a player:</h4>
<form method="get">
    <div class="form-group d-flex">
        <select name="SelectedPlayerId" class="form-control w-25">
            <option value="">-- Choose Player --</option>
            @foreach (var player in Model.Players)
            {
                if (player.PlayerId == Model.SelectedPlayerId)
                {
                    <option value="@player.PlayerId" selected="selected">@player.FirstName</option>
                }
                else
                {
                    <option value="@player.PlayerId">@player.FirstName</option>
                }
            }
        </select>
        <button type="submit" class="btn btn-info ml-2">Show Details</button>
    </div>
</form>

@* Selected player card with edit/delete *@
@if (Model.SelectedPlayer != null)
{
    <div class="mt-4 alert alert-secondary">
        <h5>Selected Player:</h5>
        <p><strong>Name:</strong> @Model.SelectedPlayer.FirstName</p>
        <p><strong>Player ID:</strong> @Model.SelectedPlayer.PlayerId</p>
        <p><strong>Phone:</strong> @Model.SelectedPlayer.Phone</p>
        <p><strong>Country:</strong> @Model.SelectedPlayer.Country</p>

        <div class="d-flex mt-2">
            <a asp-page="/EditPlayer" asp-route-id="@Model.SelectedPlayer.Id" class="btn btn-warning">
                ✏️ Edit Player
            </a>

            @* Delete player (and their games) *@
            <form method="post"
                  asp-page-handler="DeletePlayer"
                  asp-route-id="@Model.SelectedPlayer.Id"
                  onsubmit="return confirm('Are you sure you want to delete this player and all their games?');"
                  class="ml-2"
                  asp-antiforgery="true">
                <button type="submit" class="btn btn-danger" title="Delete Player">🗑</button>
            </form>
        </div>
    </div>
}

@* Selected player's games + Replay action (server-side replay) *@
@if (Model.SelectedPlayerGames.Any())
{
    <h4 class="mt-4">Games Played by @Model.SelectedPlayer.FirstName:</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Start Time</th>
                <th>Duration</th>
                <th>Moves</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var game in Model.SelectedPlayerGames)
            {
                <tr>
                    <td>@game.StartTime.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>@game.Duration.ToString(@"hh\:mm\:ss")</td>
                    <td>@game.MovesColumns</td>
                    <td>
                        @* Replay launches the client with server replay parameters *@
                        <form method="post" asp-page-handler="Replay" class="d-inline" asp-antiforgery="true">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="gameId" value="@game.GameId" />
                            <input type="hidden" name="playerId" value="@Model.SelectedPlayerId" />
                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                Replay this game
                            </button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<hr class="mt-5" />

@* Sorting controls for players list *@
<div class="mb-3">
    <a class="btn btn-outline-primary" asp-page="/Queries" asp-route-sort="insensitive">Sort by Name (Case-Insensitive)</a>
    <a class="btn btn-outline-secondary" asp-page="/Queries" asp-route-sort="sensitive">Sort by Name (Case-Sensitive)</a>
</div>

@* 17. All players with all details (sortable) *@
<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>First Name</th>
            <th>Player ID</th>
            <th>Phone</th>
            <th>Country</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var player in Model.Players)
        {
            <tr>
                <td>@player.FirstName</td>
                <td>@player.PlayerId</td>
                <td>@player.Phone</td>
                <td>@player.Country</td>
            </tr>
        }
    </tbody>
</table>

<hr class="mt-5" />

@* 22. Games per player (counts) *@
<h4>🎮 Games Played per Player</h4>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Player Name</th>
            <th>Number of Games</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var row in Model.PlayerGameCounts)
        {
            <tr>
                <td>@row.Name</td>
                <td>@row.GameCount</td>
            </tr>
        }
    </tbody>
</table>

<hr class="mt-5" />

@* 18. Last game date per player (case-sensitive name sort DESC, only name + last date) *@
<h4>📅 Last Game Date Per Player (Case-Sensitive DESC)</h4>
<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Player Name</th>
            <th>Last Game Date</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var row in Model.LastGameResults)
        {
            <tr>
                <td>@row.Name</td>
                <td>
                    @if (row.LastGameDate.HasValue)
                    {
                        @row.LastGameDate.Value.ToString("yyyy-MM-dd HH:mm")
                    }
                    else
                    {
                        <span class="text-muted">No games</span>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<hr class="mt-5" />

@* 19. All games with all details *@
<h4>🎮 All Games Played</h4>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Game ID</th>
            <th>Player</th>
            <th>Start Time</th>
            <th>Duration</th>
            <th>Moves</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var game in Model.AllGames)
        {
            <tr>
                <td>@game.GameId</td>
                <td>@game.PlayerName</td>
                <td>@game.StartTime.ToString("yyyy-MM-dd HH:mm")</td>
                <td>@game.Duration.ToString(@"hh\:mm\:ss")</td>
                <td>@game.MovesColumns</td>
                <td>
                    <form method="post" asp-page-handler="DeleteGame" asp-route-id="@game.GameId" onsubmit="return confirm('Are you sure you want to delete this game?');" asp-antiforgery="true">
                        <button type="submit" class="btn btn-sm btn-danger" title="Delete Game">🗑</button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

<hr class="mt-5" />

@* 20. Distinct games (by player) using a representative game per player *@
<h3>🎯 Distinct Games by Player</h3>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Player</th>
            <th>Start Time</th>
            <th>Duration</th>
            <th>Moves</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var game in Model.UniqueGamesByPlayer)
        {
            <tr>
                <td>@game.PlayerName</td>
                <td>@game.StartTime.ToString("yyyy-MM-dd HH:mm")</td>
                <td>@game.Duration.ToString(@"hh\:mm\:ss")</td>
                <td>@game.MovesColumns</td>
            </tr>
        }
    </tbody>
</table>

<hr class="mt-5" />

@* 23. Group players by number of games (descending) *@
<h3>🎮 Players Grouped by Number of Games</h3>
@foreach (var group in Model.GroupedPlayersByGameCount)
{
    <h4>@group.GameCount @((group.GameCount == 1) ? "Game" : "Games"):</h4>
    <ul>
        @foreach (var player in group.Players)
        {
            <li>@player.FirstName (@player.PlayerId)</li>
        }
    </ul>
}

<hr class="mt-5" />

@* 24. Group players by country *@
<h3>🌍 Players Grouped by Country</h3>
@foreach (var group in Model.GroupedPlayersByCountry)
{
    <h4>@group.Country</h4>
    <ul>
        @foreach (var player in group.Players)
        {
            <li>@player.FirstName (@player.PlayerId)</li>
        }
    </ul>
}
